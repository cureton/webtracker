<!DOCTYPE html>
<html>
<head>
  <title>AlphaSpid Tracker with Az/El and Map</title>
  <script src="https://unpkg.com/satellite.js/dist/satellite.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    canvas { max-width: 500px; max-height: 500px; }
    #map { height: 400px; width: 100%; }
  </style>
</head>
<body>
  <h1>AlphaSpid Satellite Tracker</h1>

  <textarea id="tle" rows="3" cols="80">1 25544U 98067A   24140.59773148  .00005450  00000+0  10384-3 0  9994
2 25544  51.6417  45.6747 0003224  64.3883 295.7571 15.50685758445177</textarea><br>
  <button id="connect">Connect to Rotator</button>
  <button id="start">Start Tracking</button>

  <pre id="log"></pre>

  <h2>Live Az/El Plot</h2>
  <canvas id="azelChart"></canvas>

  <h2>Live Ground Track</h2>
  <div id="map"></div>

  <script>
    let port, writer, satrec, intervalId, chart, map, satMarker, trailLine;
    const trailCoords = [];

    const observerGd = {
      latitude: satellite.degreesToRadians(-33.865143),
      longitude: satellite.degreesToRadians(151.209900),
      height: 0.02
    };

    // Initialize map
    map = L.map('map').setView([-33.865, 151.209], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map &copy; OpenStreetMap contributors'
    }).addTo(map);

    // Observer marker
    const observerMarker = L.circleMarker([-33.865143, 151.209900], {
      radius: 5,
      color: 'red',
      fillColor: '#f03',
      fillOpacity: 0.8
    }).addTo(map).bindPopup("Observer");

    document.getElementById('connect').addEventListener('click', async () => {
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 9600 });

      const encoder = new TextEncoderStream();
      encoder.readable.pipeTo(port.writable);
      writer = encoder.writable.getWriter();

      log("Connected to serial port.");
    });

    document.getElementById('start').addEventListener('click', () => {
      const lines = document.getElementById('tle').value.trim().split('\n');
      if (lines.length < 2) {
        log("Please enter 2 lines of TLE.");
        return;
      }

      satrec = satellite.twoline2satrec(lines[0], lines[1]);
      setupChart();

      intervalId = setInterval(() => {
        const now = new Date();
        const gmst = satellite.gstime(now);
        const posVel = satellite.propagate(satrec, now);
        if (!posVel.position) return;

        const look = satellite.ecfToLookAngles(observerGd,
                      satellite.eciToEcf(posVel.position, gmst));

        const az = satellite.radiansToDegrees(look.azimuth);
        const el = satellite.radiansToDegrees(look.elevation);

        const azCmd = Math.round(az * 10).toString().padStart(4, '0');
        const elCmd = Math.round(el * 10).toString().padStart(3, '0');
        const command = `W${azCmd}${elCmd}\r`;

        if (writer) {
          writer.write(command);
          log(`${now.toLocaleTimeString()} → AZ: ${az.toFixed(1)} EL: ${el.toFixed(1)} → ${command.trim()}`);
        }

        // Plot Az/El
        if (el > 0) {
          chart.data.datasets[0].data.push({ x: az, y: el });
          chart.update();
        }

        // Compute satellite ground position
        const geodetic = satellite.eciToGeodetic(posVel.position, gmst);
        const satLat = satellite.degreesLat(geodetic.latitude);
        const satLng = satellite.degreesLong(geodetic.longitude);

        // Update map
        if (!satMarker) {
          satMarker = L.circleMarker([satLat, satLng], {
            radius: 4, color: 'blue', fillColor: 'cyan', fillOpacity: 0.9
          }).addTo(map).bindPopup("Satellite");
        } else {
          satMarker.setLatLng([satLat, satLng]);
        }

        trailCoords.push([satLat, satLng]);
        if (trailCoords.length > 200) trailCoords.shift();

        if (trailLine) map.removeLayer(trailLine);
        trailLine = L.polyline(trailCoords, { color: 'blue' }).addTo(map);

      }, 1000);
    });

    function log(msg) {
      const el = document.getElementById('log');
      el.textContent += msg + '\n';
      el.scrollTop = el.scrollHeight;
    }

    function setupChart() {
      const ctx = document.getElementById('azelChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Satellite Track',
            data: [],
            showLine: true,
            borderWidth: 1,
            pointRadius: 2
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            r: {
              type: 'radialLinear',
              min: 0,
              max: 90,
              ticks: { stepSize: 15 },
              pointLabels: {
                callback: (value) => `${value}°`
              }
            },
            x: { display: false },
            y: { display: false }
          },
          parsing: {
            xAxisKey: 'x',
            yAxisKey: 'y'
          },
          aspectRatio: 1,
        }
      });
    }
  </script>
</body>
</html>
